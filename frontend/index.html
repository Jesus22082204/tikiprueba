<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calidad del Aire - Aguachica</title>

  <!-- Tailwind + Leaflet -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- App styles -->
  <link rel="stylesheet" href="style.css" />

  <style>
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .point-selector {
      max-height: 220px;
      overflow-y: auto;
    }

    .point-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .point-item:hover {
      background-color: #f3f4f6;
    }

    .point-item.active {
      background-color: #dbeafe;
      border-left: 4px solid #3b82f6;
    }

    .main-point {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
    }

    .main-point.active {
      background-color: #fcd34d;
      border-left: 4px solid #d97706;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">
  <!-- Header -->
  <header class="flex flex-col md:flex-row justify-between items-center bg-white shadow px-6 py-4 gap-3">
    <div class="flex items-center space-x-2">
      <span class="text-2xl">üåç</span>
      <h1 class="text-xl md:text-2xl font-bold text-blue-700">Calidad del Aire - Aguachica (Vista General)</h1>
    </div>
    <div class="flex items-center space-x-3">
      <button onclick="showGeneralView()"
        class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition text-sm">
        Vista General
      </button>

      <!-- Header 
      <button onclick="getAllPointsSummary()" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition text-sm">
        Resumen
      </button> -->
<div class="relative">
  <button id="exportBtn" onclick="toggleExportMenu()" 
          class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition text-sm flex items-center space-x-2">
    <span>üìä Exportar Datos</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>
  
  <!-- Men√∫ desplegable -->
  <div id="exportMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200" style="z-index: 9999;">
    <div class="py-2">
      <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">Seleccionar per√≠odo</div>
      
      <button onclick="exportData('24h')" 
              class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center space-x-2 transition">
        <span>üïê</span>
        <div>
          <div class="font-medium text-gray-800">√öltimas 24 horas</div>
          <div class="text-xs text-gray-500">Datos del √∫ltimo d√≠a</div>
        </div>
      </button>
      
      <button onclick="exportData('month')" 
              class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center space-x-2 transition">
        <span>üìÖ</span>
        <div>
          <div class="font-medium text-gray-800">√öltimo mes</div>
          <div class="text-xs text-gray-500">Datos de los √∫ltimos 30 d√≠as</div>
        </div>
      </button>
      
      <button onclick="exportData('year')" 
              class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center space-x-2 transition">
        <span>üìä</span>
        <div>
          <div class="font-medium text-gray-800">√öltimo a√±o</div>
          <div class="text-xs text-gray-500">Datos de los √∫ltimos 365 d√≠as</div>
        </div>
      </button>
      
      <div class="border-t mt-2 pt-2 px-4 pb-2">
        <div class="text-xs text-gray-500">
          üìç Punto actual: <span id="currentPointName" class="font-medium">Aguachica General</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Animaci√≥n del men√∫ desplegable */
  #exportMenu {
    animation: slideDown 0.2s ease-out;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Cerrar men√∫ al hacer clic fuera */
  .export-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9998;
  }
  
  /* Asegurar que el contenedor del bot√≥n tambi√©n tenga z-index alto */
  #exportBtn {
    position: relative;
    z-index: 9999;
  }
</style>

<script>
// Funciones para el men√∫ de exportaci√≥n
function toggleExportMenu() {
  const menu = document.getElementById('exportMenu');
  const isHidden = menu.classList.contains('hidden');
  
  if (isHidden) {
    menu.classList.remove('hidden');
    // Agregar overlay para cerrar al hacer clic fuera
    const overlay = document.createElement('div');
    overlay.className = 'export-overlay';
    overlay.onclick = () => {
      menu.classList.add('hidden');
      overlay.remove();
    };
    document.body.appendChild(overlay);
  } else {
    menu.classList.add('hidden');
    document.querySelector('.export-overlay')?.remove();
  }
}

async function exportData(period) {
  // Cerrar men√∫
  document.getElementById('exportMenu').classList.add('hidden');
  document.querySelector('.export-overlay')?.remove();
  
  // Obtener punto actual
  const currentPointId = selectedPointId || 'aguachica_general';
  const currentPoint = pointsOfInterest.find(p => p.id === currentPointId);
  
  // Mostrar indicador de carga
  const btn = document.getElementById('exportBtn');
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<div class="loading-spinner"></div><span>Generando archivo...</span>';
  btn.disabled = true;
  
  try {
    const API_BASE = 'http://127.0.0.1:5000';
    const response = await fetch(`${API_BASE}/api/export/${currentPointId}?period=${period}`);
    
    if (!response.ok) {
      throw new Error('Error al generar el archivo');
    }
    
    // Descargar el archivo
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // Nombre del archivo con fecha y ubicaci√≥n
    const fecha = new Date().toISOString().split('T')[0];
    const locationName = currentPoint.name.replace(/\s+/g, '_').toLowerCase();
    const periodName = {
      '24h': '24_horas',
      'month': 'ultimo_mes',
      'year': 'ultimo_a√±o'
    }[period];
    
    a.download = `datos_calidad_aire_${locationName}_${periodName}_${fecha}.xlsx`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    // Mostrar mensaje de √©xito
    alert(`‚úÖ Archivo exportado exitosamente:\n${a.download}`);
    
  } catch (error) {
    console.error('Error al exportar datos:', error);
    alert('‚ùå Error al exportar datos. Por favor, intenta nuevamente.');
  } finally {
    // Restaurar bot√≥n
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
}

// Actualizar nombre del punto actual en el men√∫
function updateCurrentPointName() {
  const currentPointId = selectedPointId || 'aguachica_general';
  const currentPoint = pointsOfInterest.find(p => p.id === currentPointId);
  const nameElement = document.getElementById('currentPointName');
  if (nameElement && currentPoint) {
    nameElement.textContent = currentPoint.name;
  }
}

// Llamar al cambiar de punto
const originalShowPointDetailsExport = window.showPointDetails;
window.showPointDetails = function(pointId) {
  if (originalShowPointDetailsExport) originalShowPointDetailsExport(pointId);
  updateCurrentPointName();
};
</script>









    </div>
  </header>

  <div class="flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside class="w-full md:w-1/4 bg-white shadow p-5 space-y-6">
      <div>
        <label class="block text-sm font-medium mb-2">Puntos de Inter√©s</label>
        <div id="pointSelector" class="point-selector border rounded p-2 space-y-1">
          <!-- Punto principal -->
          <div class="point-item main-point p-3 rounded text-sm active" onclick="showPointDetails('aguachica_general')">
            <div class="flex items-center">
              <span class="text-lg mr-2">üèõÔ∏è</span>
              <div>
                <div class="font-semibold">Aguachica - Vista General</div>
                <div class="text-xs text-gray-600">Datos generales de la ciudad</div>
              </div>
            </div>
          </div>

          <div class="border-t my-2 text-xs text-gray-500 text-center">Puntos espec√≠ficos</div>

          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('parque_central')">
            <div class="flex items-center"><span class="mr-2">üèõÔ∏è</span><span>Parque Central</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('universidad')">
            <div class="flex items-center"><span class="mr-2">üìö</span><span>Universidad Popular del Cesar</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('parque_morrocoy')">
            <div class="flex items-center"><span class="mr-2">üå≥</span><span>Parque Morrocoy</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('patinodromo')">
            <div class="flex items-center"><span class="mr-2">üèüÔ∏è</span><span>Patin√≥dromo</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('ciudadela_paz')">
            <div class="flex items-center"><span class="mr-2">üèòÔ∏è</span><span>Ciudadela de la Paz</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('bosque')">
            <div class="flex items-center"><span class="mr-2">üå≤</span><span>Bosque</span></div>
          </div>
          <div class="point-item p-2 rounded text-sm" onclick="showPointDetails('estadio')">
            <div class="flex items-center"><span class="mr-2">‚öΩ</span><span>Estadio</span></div>
          </div>
        </div>
      </div>

      <!-- Estado de carga -->
      <div id="loadingStatus" class="bg-blue-50 p-3 rounded-lg">
        <div class="flex items-center text-sm text-blue-700">
          <div class="loading-spinner"></div>
          <span>Cargando datos de todos los puntos...</span>
        </div>
      </div>
    </aside>

    <!-- Dashboard -->
    <main class="flex-1 p-4 md:p-8 space-y-8">
      <!-- Mapa -->
      <section class="bg-white rounded-2xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-gray-700 text-lg">Estaciones con AQI - Aguachica</h3>
          <div class="text-sm text-gray-500"><span id="mapStatus">Cargando estaciones...</span></div>
        </div>
        <div id="map" class="w-full h-64 md:h-80 rounded-xl mb-4"></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600">
          <p>üìç Ubicaci√≥n: Aguachica, Cesar (Vista General)</p>
          <p>üó∫Ô∏è Coordenadas: 8.312, -73.626</p>
          <p>üå´Ô∏è Contaminante principal: PM‚ÇÇ.‚ÇÖ</p>
          <p>‚è∞ √öltima actualizaci√≥n: <span id="lastUpdate">Cargando...</span></p>
        </div>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-700">
            üí° <strong>Leyenda:</strong>
            <span class="inline-flex items-center mx-2"><span
                class="w-3 h-3 bg-yellow-400 rounded-full mr-1"></span>Vista General (dorado)</span>
            <span class="inline-flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>Puntos
              espec√≠ficos (azul)</span>
          </p>
          <p class="text-sm text-blue-700 mt-1">Haz clic en cualquier marcador para ver informaci√≥n detallada de esa
            ubicaci√≥n.</p>
        </div>
      </section>

      <!-- Indicadores + Resumen -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="bg-white rounded-2xl shadow p-6 space-y-4 lg:col-span-3">
          <h3 class="font-semibold text-gray-700 text-lg">Indicadores</h3>
          <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-green-100 rounded-xl p-4 shadow">
              <p class="text-sm">üå´Ô∏è PM2.5</p>
              <p id="pm25" class="font-bold text-xl">Cargando...</p>
            </div>
            <div class="bg-yellow-100 rounded-xl p-4 shadow">
              <p class="text-sm">üí® PM10</p>
              <p id="pm10" class="font-bold text-xl">Cargando...</p>
            </div>
            <div class="bg-blue-100 rounded-xl p-4 shadow">
              <p class="text-sm">üå°Ô∏è Temp</p>
              <p id="temperature" class="font-bold text-xl">Cargando...</p>
            </div>
            <div class="rounded-xl p-4 shadow" id="airQuality">
              <p class="text-sm">‚úÖ Calidad</p>
              <p class="font-bold text-xl" id="qualityMessage">Cargando...</p>
            </div>
          </div>
          <button id="btnGenerarInterpretacion"
            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">
            Generar Interpretaci√≥n
          </button>
        </section>

        <section id="summaryCard" class="bg-white rounded-2xl shadow p-6 space-y-3 lg:col-span-3">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-800">Resumen del d√≠a</h2>
            <span id="summaryBadge" class="text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-600">‚Äî</span>
          </div>
          <p id="dailySummary" class="text-gray-700 leading-relaxed">Cargando interpretaci√≥n de la calidad del aire...
          </p>
          <ul id="dailyAdvice" class="list-disc pl-5 text-gray-700 text-sm space-y-1"></ul>
        </section>

        <!-- Tendencias y distribuci√≥n (unificadas) -->
        <section id="trendsSection" class="bg-white rounded-2xl shadow p-6 space-y-6 lg:col-span-3" hidden>
          <div class="flex items-center justify-between">
            <h3 class="font-semibold text-gray-700 text-lg">Tendencias 24 h y Distribuci√≥n</h3>
            <span class="text-xs text-gray-500">Haz clic en la leyenda para ocultar/mostrar contaminantes</span>
          </div>
          <div id="trendsMsg" class="text-sm text-gray-500"></div>

          <!-- √öNICA gr√°fica combinada -->
          <div class="chart-wrap">
            <canvas id="combinedTrend"></canvas>
          </div>

          <!-- Distribuci√≥n AQI (torta) -->
          <div>
            <h4 class="text-sm font-medium text-gray-600 mb-2">Distribuci√≥n AQI (7 d√≠as)</h4>
            <div class="aqi-donut-wrap">
              <canvas id="aqiDistribution"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-2">
              Escala OpenWeather: 1=Bueno, 2=Aceptable, 3=Moderado, 4=Deficiente, 5=Muy deficiente.
            </p>
          </div>
        </section>
      </div>

      <!-- Heatmap + Pron√≥stico -->
      <section class="bg-white rounded-2xl shadow p-6">
        <h3 class="font-semibold text-gray-700 text-lg mb-4">Heatmap horario</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-center border" id="heatmapTable">
            <thead>
              <tr class="bg-blue-50 text-gray-700">
                <th>Hora</th>
                <th>PM‚ÇÇ.‚ÇÖ</th>
                <th>PM‚ÇÅ‚ÇÄ</th>
                <th>O‚ÇÉ</th>
                <th>NO‚ÇÇ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-3 text-xs text-gray-500">Colores representan mayor (rojo) o menor (verde) concentraci√≥n.</div>
        <div id="forecastMessage" class="mt-4 text-base font-medium text-center">Cargando pron√≥stico...</div>
      </section>

      <!-- Boxplots -->
      <section class="bg-white rounded-2xl shadow p-6">
        <h3 class="font-semibold text-gray-700 text-lg mb-4">Boxplots mensuales PM‚ÇÇ.‚ÇÖ y PM‚ÇÅ‚ÇÄ (2025)</h3>
        <div class="overflow-x-auto">
          <table id="boxplotTable" class="w-full text-sm text-center border-collapse border">
            <thead>
              <tr class="bg-gray-100">
                <th rowspan="2">Mes</th>
                <th colspan="5">PM‚ÇÇ.‚ÇÖ</th>
                <th colspan="5">PM‚ÇÅ‚ÇÄ</th>
                <th rowspan="2">AQI Prom.</th>
              </tr>
              <tr class="bg-gray-50">
                <th>Mediana</th>
                <th>Q1</th>
                <th>Q3</th>
                <th>M√≠n</th>
                <th>M√°x</th>
                <th>Mediana</th>
                <th>Q1</th>
                <th>Q3</th>
                <th>M√≠n</th>
                <th>M√°x</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Anomal√≠as -->
      <section class="bg-white rounded-2xl shadow p-6">
        <h3 class="font-semibold text-gray-700 text-lg mb-4">Anomal√≠as detectadas</h3>
        <ul id="anomaliasList" class="list-disc ml-6 text-sm text-gray-700 space-y-1">
          <li class="text-gray-500">Cargando anomal√≠as...</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-200 text-gray-600 text-center py-3 text-sm mt-6">
    Datos: IDEAM / Datos.gov.co / Corpocesar /OpenWeather | √öltima actualizaci√≥n: <span
      id="footerUpdate">Cargando...</span>
  </footer>

  <script>
    // Estado de carga (igual que tu base)
    function updateLoadingStatus(message, isComplete = false) {
      const statusElement = document.getElementById('loadingStatus');
      const mapStatusElement = document.getElementById('mapStatus');
      if (isComplete) {
        statusElement.innerHTML = '<div class="flex items-center text-sm text-green-700"><span class="text-green-500 mr-2">‚úÖ</span><span>' + message + '</span></div>';
        mapStatusElement.textContent = 'Todas las estaciones cargadas';
        const now = new Date().toLocaleString('es-ES');
        document.getElementById('lastUpdate').textContent = now;
        document.getElementById('footerUpdate').textContent = now;
      } else {
        statusElement.innerHTML = '<div class="flex items-center text-sm text-blue-700"><div class="loading-spinner"></div><span>' + message + '</span></div>';
        mapStatusElement.textContent = message;
      }
    }

    // Visual select en Sidebar
    function updatePointSelection(selectedId) {
      const items = document.querySelectorAll('.point-item');
      items.forEach(i => i.classList.remove('active'));
      const selectedElement = Array.from(items).find(el => el.getAttribute('onclick')?.includes(selectedId));
      if (selectedElement) selectedElement.classList.add('active');
    }

    // Envolver showPointDetails para adem√°s refrescar tendencias
    const originalShowPointDetails = window.showPointDetails;
    window.showPointDetails = function (pointId) {
      updatePointSelection(pointId);
      if (originalShowPointDetails) originalShowPointDetails(pointId);
      if (window.updateTrendsCharts) window.updateTrendsCharts(pointId);
    };

    updateLoadingStatus('Inicializando aplicaci√≥n...');
  </script>

  

  <!-- Tu script principal (mapa + indicadores) -->
  <script src="script.js"></script>
  <!-- Tendencias unificadas -->
  <script src="trends.js"></script>
</body>

</html>